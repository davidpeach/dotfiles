#----------------------------------------
# Installation script that I use to setup
# my Lenovo Thinkpad T470 / T490
#----------------------------------------

DOTFILES_DIR=$PWD
CONFIG_DIR="$HOME/.config"
LOCAL_BIN_DIR="$HOME/.local/bin"
INSTALL_OFFICIAL_PACKAGES=false
INSTALL_AUR_PACKAGES=false

# -------------------------------
# Installing the packages I need.
# -------------------------------
if [[ "$INSTALL_OFFICIAL_PACKAGES" == true ]]; then
	sudo pacman -S --noconfirm --needed - < packages.txt
fi

if [[ "$INSTALL_AUR_PACKAGES" == true ]]; then

	if [[ ! -x $(command -v yay)  ]]; then
		echo "Stopping :: Please install the yay package"
		exit
	else

		yay -S --noconfirm --needed - < packages-aur.txt
	fi
fi

# --- Symlinking Section ---

# Create directories if they don't exist
mkdir -p "$CONFIG_DIR"
mkdir -p "$LOCAL_BIN_DIR"

# 1. Config directories to link into ~/.config/
config_dirs=(sway nvim nvim_refresh wallpapers ranger alacritty lynx dunst task kitty)

echo "--- Symlinking .config directories ---"
for dir in "${config_dirs[@]}"; do
    # Before linking, remove the target if it's already a symlink
    if [ -L "${CONFIG_DIR}/${dir}" ]; then
        rm "${CONFIG_DIR}/${dir}"
    fi
    ln -s "$DOTFILES_DIR/$dir" "$CONFIG_DIR/" && echo "Linked $dir"
done

# 2. Files to link directly into ~/
home_files=(.tmux.conf .bashrc .inputrc .xinitrc .Xresources)

echo "--- Symlinking home files ---"
for file in "${home_files[@]}"; do
    if [ -L "${HOME}/${file}" ]; then
        rm "${HOME}/${file}"
    fi
    ln -s "$DOTFILES_DIR/$file" "$HOME/" && echo "Linked $file"
done

if [ -L "${HOME}/.vimrc" ]; then
    rm "${HOME}/.vimrc"
fi
ln -s "$DOTFILES_DIR/nvim_refresh/vimrc" "$HOME/.vimrc" && echo "Linked new vimrc"

# 3. Special cases like scripts and gitignore
echo "--- Symlinking special cases ---"
if [ -L "$LOCAL_BIN_DIR" ]; then rm "$LOCAL_BIN_DIR"; fi
ln -s "$DOTFILES_DIR/scripts" "$LOCAL_BIN_DIR" && echo "Linked scripts"

if [ -L "${HOME}/.gitignore" ]; then rm "${HOME}/.gitignore"; fi
ln -s "$DOTFILES_DIR/git/gitignore" "${HOME}/.gitignore" && echo "Linked global gitignore"

# SSH Key Generation
# ssh-keygen -t rsa -f "$HOME"/.ssh/marnie -C "Marnie" -b 4096

# GPG key setup
# Might use a YubiKey
# Git config global settings (dotfile?)

# add the include into ssh config

# EXPECTED_CHECKSUM="$(php -r 'copy("https://composer.github.io/installer.sig", "php://stdout");')"
# php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
# ACTUAL_CHECKSUM="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"
#
# if [ "$EXPECTED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]
# then
#     >&2 echo 'ERROR: Invalid installer checksum'
#     rm composer-setup.php
#     exit 1
# fi
#
# php composer-setup.php --quiet
# RESULT=$?
# rm composer-setup.php
# sudo mv composer.phar /usr/local/bin/composer

echo "This setup file is not yet complete."
